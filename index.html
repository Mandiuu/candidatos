<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidatos Congreso Nacional Chile 2025 - Datos Integrados</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0066CC 0%, #003D7A 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .title {
            font-size: 2.5em;
            font-weight: 800;
            background: linear-gradient(135deg, #0066CC 0%, #D52B1E 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #666;
            margin-top: 10px;
        }

        .info-banner {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #0066CC;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .map-section {
            margin-bottom: 40px;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .map-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .map-chile {
            display: grid;
            grid-template-areas:
                "arica arica"
                "tarapaca tarapaca"
                "antofagasta antofagasta"
                "atacama atacama"
                "coquimbo coquimbo"
                "valparaiso valparaiso"
                "metropolitana metropolitana"
                "ohiggins ohiggins"
                "maule maule"
                "nuble nuble"
                "biobio biobio"
                "araucania araucania"
                "rios rios"
                "lagos lagos"
                "aysen aysen"
                "magallanes magallanes"
                "antartica antartica";
            gap: 8px;
            max-width: 400px;
            margin: 0 auto;
        }

        .map-region {
            position: relative;
            min-height: 40px;
            transition: all 0.3s ease;
        }
        
        .map-region.arica { grid-area: arica; }
        .map-region.tarapaca { grid-area: tarapaca; }
        .map-region.antofagasta { grid-area: antofagasta; }
        .map-region.atacama { grid-area: atacama; }
        .map-region.coquimbo { grid-area: coquimbo; }
        .map-region.valparaiso { grid-area: valparaiso; }
        .map-region.metropolitana { grid-area: metropolitana; }
        .map-region.ohiggins { grid-area: ohiggins; }
        .map-region.maule { grid-area: maule; }
        .map-region.nuble { grid-area: nuble; }
        .map-region.biobio { grid-area: biobio; }
        .map-region.araucania { grid-area: araucania; }
        .map-region.rios { grid-area: rios; }
        .map-region.lagos { grid-area: lagos; }
        .map-region.aysen { grid-area: aysen; }
        .map-region.magallanes { grid-area: magallanes; }
        .map-region.antartica { grid-area: antartica; }


        .region-box {
            background: #E3F2FD;
            border: 2px solid #0066CC;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            height: 100%;
        }

        .region-box:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
        }

        .region-box.destacada {
            border-width: 3px;
            font-weight: 600;
            background-color: #003D7A;
            border-color: #0066CC;
        }

        .region-box.destacada .region-name {
            color: white;
        }
        
        .region-box.destacada .region-count {
            color: #0066CC;
            background: white;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .region-box.active {
            border-color: #D52B1E;
            background: #FFEBEE;
        }

        .region-name {
            font-size: 0.9em;
            color: #333;
        }

        .region-count {
            font-size: 1.2em;
            font-weight: bold;
            color: #0066CC;
            background: white;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .map-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .map-legend {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
        }

        .map-legend h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        .region-details {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            min-height: 150px;
        }

        .region-details h4 {
            color: #0066CC;
            margin-bottom: 10px;
        }

        .region-details p {
            color: #666;
            font-size: 0.9em;
        }

        .region-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .region-stat {
            background: white;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .region-stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #0066CC;
        }

        .region-stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 400px;
        }

        .chart-container canvas {
            max-height: 320px !important;
        }

        .chart-title {
            margin-bottom: 40px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .detail-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .detail-card h3 {
            color: #0066CC;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            max-width: 60%;
        }

        .detail-value {
            color: #666;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066CC, #4facfe);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .filters-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .filter-input, .filter-select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #0066CC;
        }

        .tabs {
            background: white;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            display: flex;
            gap: 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #0066CC 0%, #003D7A 100%);
            color: white;
        }

        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .candidate-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 4px solid;
            transition: transform 0.3s ease;
        }

        .candidate-card:hover {
            transform: translateY(-5px);
        }

        .candidate-card.senador {
            border-left-color: #0066CC;
        }

        .candidate-card.diputado {
            border-left-color: #D52B1E;
        }

        .candidate-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .cargo-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            color: white;
            margin-left: 10px;
        }

        .cargo-badge.senador {
            background: #0066CC;
        }

        .cargo-badge.diputado {
            background: #D52B1E;
        }

        .candidate-party {
            display: inline-block;
            padding: 5px 15px;
            background: #0066CC;
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px 5px 10px 0;
        }

        .candidate-info {
            color: #666;
            line-height: 1.8;
        }

        .results-info {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }

        .pagination button {
            padding: 10px 15px;
            border: 2px solid #0066CC;
            background: white;
            color: #0066CC;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #0066CC;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #0066CC;
            color: white;
        }

        @media (max-width: 768px) {
            .title { font-size: 1.8em; }
            .stats-grid { grid-template-columns: 1fr; }
            .filter-grid { grid-template-columns: 1fr; }
            .candidates-grid { grid-template-columns: 1fr; }
            .map-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Candidatos Congreso Nacional 2025</h1>
            <p class="subtitle">Visualizaci√≥n completa de candidatos a Senadores y Diputados de Chile</p>
        </div>

      
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalCandidatos">0</div>
                <div class="stat-label">Total Candidatos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalSenadores">0</div>
                <div class="stat-label">Senadores</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDiputados">0</div>
                <div class="stat-label">Diputados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPartidos">0</div>
                <div class="stat-label">Partidos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPactos">0</div>
                <div class="stat-label">Pactos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRegiones">0</div>
                <div class="stat-label">Regiones</div>
            </div>
        </div>

        <div class="tabs" id="tabs">
            <button class="tab-button active" onclick="setTab('todos')">Todos</button>
            <button class="tab-button" onclick="setTab('senadores')">Senadores</button>
            <button class="tab-button" onclick="setTab('diputados')">Diputados</button>
        </div>

        <div class="filters-section">
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Buscar candidato</label>
                    <input type="text" class="filter-input" id="nameInput" placeholder="Nombre..." list="candidateNames" onkeyup="updateFilter('search', this.value)">
                    <datalist id="candidateNames"></datalist>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Pacto</label>
                    <select class="filter-select" id="pactoFilter" onchange="updateFilter('pacto', this.value)">
                        <option value="">Todos los pactos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Partido</label>
                    <select class="filter-select" id="partidoFilter" onchange="updateFilter('partido', this.value)">
                        <option value="">Todos los partidos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Regi√≥n</label>
                    <select class="filter-select" id="regionFilter" onchange="updateFilter('region', this.value)">
                        <option value="">Todas las regiones</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="visualization-section">
            <h2 style="color: white; text-align: center; margin-bottom: 30px; font-size: 1.8em;">üìä Visualizaciones y An√°lisis</h2>
            
            <div class="map-container">
                <h3 class="chart-title">üó∫Ô∏è Mapa de Distribuci√≥n por Regi√≥n</h3>
                <div class="map-grid">
                    <div class="map-chile">
                        <div class="map-region arica" data-region="Arica y Parinacota">
                            <div class="region-box">
                                <span class="region-name">Arica y Parinacota</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region tarapaca" data-region="Tarapac√°">
                            <div class="region-box">
                                <span class="region-name">Tarapac√°</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region antofagasta" data-region="Antofagasta">
                            <div class="region-box">
                                <span class="region-name">Antofagasta</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region atacama" data-region="Atacama">
                            <div class="region-box">
                                <span class="region-name">Atacama</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region coquimbo" data-region="Coquimbo">
                            <div class="region-box">
                                <span class="region-name">Coquimbo</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        
                        <div class="map-region valparaiso" data-region="Valpara√≠so">
                            <div class="region-box">
                                <span class="region-name">Valpara√≠so</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region metropolitana" data-region="Metropolitana de Santiago">
                            <div class="region-box destacada">
                                <span class="region-name">Metropolitana</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region ohiggins" data-region="O'Higgins">
                            <div class="region-box">
                                <span class="region-name">O'Higgins</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region maule" data-region="Maule">
                            <div class="region-box">
                                <span class="region-name">Maule</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region nuble" data-region="√ëuble">
                            <div class="region-box">
                                <span class="region-name">√ëuble</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        
                        <div class="map-region biobio" data-region="Biob√≠o">
                            <div class="region-box">
                                <span class="region-name">Biob√≠o</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region araucania" data-region="Araucan√≠a">
                            <div class="region-box">
                                <span class="region-name">Araucan√≠a</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region rios" data-region="Los R√≠os">
                            <div class="region-box">
                                <span class="region-name">Los R√≠os</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region lagos" data-region="Los Lagos">
                            <div class="region-box">
                                <span class="region-name">Los Lagos</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        
                        <div class="map-region aysen" data-region="Ays√©n">
                            <div class="region-box">
                                <span class="region-name">Ays√©n</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                        <div class="map-region magallanes" data-region="Magallanes">
                            <div class="region-box">
                                <span class="region-name">Magallanes</span>
                                <span class="region-count">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="map-info">
                        <div class="map-legend">
                            <h4>Densidad de Candidatos</h4>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #E3F2FD;"></span>
                                <span>1-30</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #90CAF9;"></span>
                                <span>31-60</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #42A5F5;"></span>
                                <span>61-90</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #1976D2;"></span>
                                <span>91-120</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #0D47A1;"></span>
                                <span>120+</span>
                            </div>
                        </div>
                        
                        <div id="regionDetails" class="region-details">
                            <h4>Selecciona una regi√≥n</h4>
                            <p>Haz clic en cualquier regi√≥n para ver sus estad√≠sticas detalladas</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Distribuci√≥n por Partido Pol√≠tico</h3>
                    <canvas id="chartPartidos"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">Candidatos por Regi√≥n</h3>
                    <canvas id="chartRegiones"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">Distribuci√≥n por Pacto Electoral</h3>
                    <canvas id="chartPactos"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">Senadores vs Diputados por Regi√≥n</h3>
                    <canvas id="chartTipoRegion"></canvas>
                </div>
            </div>

            <div class="stats-details">
                <div class="detail-card">
                    <h3>üèõÔ∏è Top 5 Partidos con m√°s candidatos</h3>
                    <div id="topPartidos"></div>
                </div>
                
                <div class="detail-card">
                    <h3>üìç Top 5 Regiones con m√°s candidatos</h3>
                    <div id="topRegiones"></div>
                </div>
                
                <div class="detail-card">
                    <h3>ü§ù Distribuci√≥n de Pactos</h3>
                    <div id="topPactos"></div>
                </div>
            </div>
        </div>

        <div class="results-info" id="resultsInfo">
            Cargando candidatos...
        </div>

        <div class="candidates-grid" id="candidatesGrid"></div>

        <div class="pagination" id="pagination"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    
    <script>
        const regionesMap = {
            'Arica y Parinacota': 'REGI√ìN DE ARICA Y PARINACOTA',
            'Tarapac√°': 'REGI√ìN DE TARAPAC√Å',
            'Antofagasta': 'REGI√ìN DE ANTOFAGASTA',
            'Atacama': 'REGI√ìN DE ATACAMA',
            'Coquimbo': 'REGI√ìN DE COQUIMBO',
            'Valpara√≠so': 'REGI√ìN DE VALPARA√çSO',
            'Metropolitana de Santiago': 'REGI√ìN METROPOLITANA DE SANTIAGO',
            "O'Higgins": "REGI√ìN DEL LIBERTADOR GENERAL BERNARDO O'HIGGINS",
            'Maule': 'REGI√ìN DEL MAULE',
            '√ëuble': 'REGI√ìN DE √ëUBLE',
            'Biob√≠o': 'REGI√ìN DEL BIOB√çO',
            'Araucan√≠a': 'REGI√ìN DE LA ARAUCAN√çA',
            'Los R√≠os': 'REGI√ìN DE LOS R√çOS',
            'Los Lagos': 'REGI√ìN DE LOS LAGOS',
            'Ays√©n': 'REGI√ìN DE AYS√âN DEL GENERAL CARLOS IB√Å√ëEZ DEL CAMPO',
            'Magallanes': 'REGI√ìN DE MAGALLANES Y DE LA ANT√ÅRTICA CHILENA'
        };

        const REVERSE_REGIONES_MAP = Object.fromEntries(
            Object.entries(regionesMap).map(([key, value]) => [value, key])
        );

        const SENADORES_URL = 'Candidatos.xlsx - Senadores.csv';
        const DIPUTADOS_URL = 'Candidatos.xlsx - Diputados.csv';

        const CANDIDATES_PER_PAGE = 10;
        
        let DATABASE = {
            senadores: [],
            diputados: []
        };
        
        let appState = {
            tab: 'todos',
            filters: {
                search: '',
                pacto: '',
                partido: '',
                region: '',
                ubicacion: ''
            },
            currentPage: 1,
            filteredCandidates: [],
            totalCandidates: 0,
            senadoresCount: 0,
            diputadosCount: 0,
            pactosCount: 0,
            partidosCount: 0,
            regionesCount: 0
        };

        const elements = {
            totalCandidatos: document.getElementById('totalCandidatos'),
            totalSenadores: document.getElementById('totalSenadores'),
            totalDiputados: document.getElementById('totalDiputados'),
            totalPactos: document.getElementById('totalPactos'),
            totalPartidos: document.getElementById('totalPartidos'),
            totalRegiones: document.getElementById('totalRegiones'),
            pactoFilter: document.getElementById('pactoFilter'),
            partidoFilter: document.getElementById('partidoFilter'),
            regionFilter: document.getElementById('regionFilter'),
            candidatesGrid: document.getElementById('candidatesGrid'),
            resultsInfo: document.getElementById('resultsInfo'),
            pagination: document.getElementById('pagination'),
            regionDetails: document.getElementById('regionDetails'),
            topPartidos: document.getElementById('topPartidos'),
            topRegiones: document.getElementById('topRegiones'),
            topPactos: document.getElementById('topPactos'),
            nameInput: document.getElementById('nameInput'),
            candidateNamesDatalist: document.getElementById('candidateNames')
        };
        
        let charts = {};

        // Nueva funci√≥n para cargar los datos desde CSV
        async function loadData() {
            try {
                elements.resultsInfo.textContent = 'Cargando datos...';
                
                const senadores = await Papa.parsePromise(SENADORES_URL);
                const diputados = await Papa.parsePromise(DIPUTADOS_URL);

                DATABASE.senadores = senadores.data.filter(c => c.NOMBRE && c.NOMBRE.trim() !== '').map(c => ({
                    n: c.NOMBRE,
                    p: c.PARTIDO || 'Independiente',
                    pa: c['PARTIDO ASOCIADO'],
                    r: c.REGI√ìN,
                    u: c.CIRCUNSCRIPCI√ìN || c.DISTRITO,
                    pc: c.PACTO || 'Sin Pacto',
                    o: c.ORDEN,
                    tipo: 'senador'
                }));

                DATABASE.diputados = diputados.data.filter(c => c.NOMBRE && c.NOMBRE.trim() !== '').map(c => ({
                    n: c.NOMBRE,
                    p: c.PARTIDO || 'Independiente',
                    pa: c['PARTIDO ASOCIADO'],
                    r: c.REGI√ìN,
                    u: c.CIRCUNSCRIPCI√ìN || c.DISTRITO,
                    pc: c.PACTO || 'Sin Pacto',
                    o: c.ORDEN,
                    tipo: 'diputado'
                }));

                calculateStats();
                populateNameDatalist();
                filterCandidates();

            } catch (error) {
                console.error("Error al cargar los datos:", error);
                elements.resultsInfo.textContent = "Error al cargar los datos. Aseg√∫rate de que los archivos 'Candidatos.xlsx - Senadores.csv' y 'Candidatos.xlsx - Diputados.csv' est√©n en la misma carpeta.";
            }
        }

        // Adaptaci√≥n de Papa Parse para usar async/await
        Papa.parsePromise = function(url) {
            return new Promise(function(resolve, reject) {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    complete: function(results) {
                        resolve(results);
                    },
                    error: function(err) {
                        reject(err);
                    }
                });
            });
        };
        
        function calculateStats() {
            const allCandidates = [...DATABASE.senadores, ...DATABASE.diputados];
            const pactos = new Set(allCandidates.map(c => c.pc).filter(Boolean));
            const partidos = new Set(allCandidates.map(c => c.p).filter(Boolean));
            const regiones = new Set(allCandidates.map(c => c.r).filter(Boolean));

            appState.totalCandidates = allCandidates.length;
            appState.senadoresCount = DATABASE.senadores.length;
            appState.diputadosCount = DATABASE.diputados.length;
            appState.pactosCount = pactos.size;
            appState.partidosCount = partidos.size;
            appState.regionesCount = regiones.size;
            
            updateStatsUI();
            
            populateFilters(pactos, partidos, regiones);
            updateVisualizations(allCandidates);
        }

        function updateStatsUI() {
            elements.totalCandidatos.textContent = appState.totalCandidates;
            elements.totalSenadores.textContent = appState.senadoresCount;
            elements.totalDiputados.textContent = appState.diputadosCount;
            elements.totalPactos.textContent = appState.pactosCount;
            elements.totalPartidos.textContent = appState.partidosCount;
            elements.totalRegiones.textContent = appState.regionesCount;
        }

        function populateFilters(pactos, partidos, regiones) {
            const sortedPactos = Array.from(pactos).sort();
            const sortedPartidos = Array.from(partidos).sort();
            const sortedRegiones = Array.from(regiones).map(r => REVERSE_REGIONES_MAP[r] || r).sort();

            const createOptions = (select, items) => {
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    select.appendChild(option);
                });
            };

            elements.pactoFilter.innerHTML = '<option value="">Todos los pactos</option>';
            createOptions(elements.pactoFilter, sortedPactos);

            elements.partidoFilter.innerHTML = '<option value="">Todos los partidos</option>';
            createOptions(elements.partidoFilter, sortedPartidos);

            elements.regionFilter.innerHTML = '<option value="">Todas las regiones</option>';
            createOptions(elements.regionFilter, sortedRegiones);
        }

        function populateNameDatalist() {
            const allCandidates = [...DATABASE.senadores, ...DATABASE.diputados];
            const uniqueNames = new Set(allCandidates.map(c => c.n));
            elements.candidateNamesDatalist.innerHTML = '';
            uniqueNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                elements.candidateNamesDatalist.appendChild(option);
            });
        }

        function filterCandidates() {
            let candidates = [];
            if (appState.tab === 'todos') {
                candidates = [...DATABASE.senadores, ...DATABASE.diputados];
            } else if (appState.tab === 'senadores') {
                candidates = DATABASE.senadores;
            } else if (appState.tab === 'diputados') {
                candidates = DATABASE.diputados;
            }

            const { search, pacto, partido, region } = appState.filters;

            const filtered = candidates.filter(c => {
                const matchesSearch = !search || (c.n && c.n.toLowerCase().includes(search.toLowerCase()));
                const matchesPacto = !pacto || (c.pc && c.pc.toLowerCase() === pacto.toLowerCase());
                const matchesPartido = !partido || (c.p && c.p.toLowerCase() === partido.toLowerCase());
                const matchesRegion = !region || (REVERSE_REGIONES_MAP[c.r] || c.r).toLowerCase() === region.toLowerCase();
                return matchesSearch && matchesPacto && matchesPartido && matchesRegion;
            });

            appState.filteredCandidates = filtered;
            appState.currentPage = 1; 
            render();
        }

        function render() {
            renderCandidates();
            renderPagination();
            updateResultsInfo();
        }

        function renderCandidates() {
            const start = (appState.currentPage - 1) * CANDIDATES_PER_PAGE;
            const end = start + CANDIDATES_PER_PAGE;
            const candidatesToShow = appState.filteredCandidates.slice(start, end);
            
            elements.candidatesGrid.innerHTML = '';
            
            if (candidatesToShow.length === 0) {
                elements.candidatesGrid.innerHTML = `<div style="text-align: center; color: #fff; grid-column: 1 / -1; font-size: 1.2em;">No se encontraron candidatos con los filtros seleccionados.</div>`;
                return;
            }

            candidatesToShow.forEach(c => {
                const card = document.createElement('div');
                card.className = `candidate-card ${c.tipo}`;
                card.innerHTML = `
                    <div class="candidate-name">${c.n}
                        <span class="cargo-badge ${c.tipo}">${c.tipo.charAt(0).toUpperCase() + c.tipo.slice(1)}</span>
                    </div>
                    <div class="candidate-party">${c.pc || 'Sin Pacto'}</div>
                    <div class="candidate-info">
                        <strong>Partido:</strong> ${c.p || 'Sin Partido'}<br>
                        <strong>Regi√≥n:</strong> ${REVERSE_REGIONES_MAP[c.r] || c.r || 'No especificada'}<br>
                        <strong>${c.tipo === 'senador' ? 'Circunscripci√≥n' : 'Distrito'}:</strong> ${c.u || 'No especificada'}
                    </div>
                `;
                elements.candidatesGrid.appendChild(card);
            });
        }

        function renderPagination() {
            elements.pagination.innerHTML = '';
            const totalPages = Math.ceil(appState.filteredCandidates.length / CANDIDATES_PER_PAGE);

            if (totalPages <= 1) return;

            const createButton = (text, page, isActive, isDisabled) => {
                const btn = document.createElement('button');
                btn.textContent = text;
                if (isActive) btn.classList.add('active');
                btn.disabled = isDisabled;
                btn.onclick = () => {
                    appState.currentPage = page;
                    render();
                };
                elements.pagination.appendChild(btn);
            };

            createButton('Anterior', appState.currentPage - 1, false, appState.currentPage === 1);

            let startPage = Math.max(1, appState.currentPage - 2);
            let endPage = Math.min(totalPages, appState.currentPage + 2);

            if (appState.currentPage <= 3) endPage = Math.min(5, totalPages);
            if (appState.currentPage > totalPages - 3) startPage = Math.max(1, totalPages - 4);
            
            if (startPage > 1) {
                createButton('1', 1, false, false);
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '0 5px';
                    dots.style.color = 'white';
                    elements.pagination.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                createButton(i, i, i === appState.currentPage, false);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '0 5px';
                    dots.style.color = 'white';
                    elements.pagination.appendChild(dots);
                }
                createButton(totalPages, totalPages, false, false);
            }

            createButton('Siguiente', appState.currentPage + 1, false, appState.currentPage === totalPages);
        }

        function updateResultsInfo() {
            const start = (appState.currentPage - 1) * CANDIDATES_PER_PAGE + 1;
            const end = Math.min(start + CANDIDATES_PER_PAGE - 1, appState.filteredCandidates.length);
            const total = appState.filteredCandidates.length;

            if (total === 0) {
                elements.resultsInfo.textContent = 'No se encontraron resultados.';
            } else {
                elements.resultsInfo.textContent = `Mostrando ${start} - ${end} de ${total} candidatos`;
            }
        }

        function setTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="setTab('${tab}')"]`).classList.add('active');
            appState.tab = tab;
            filterCandidates();
        }

        function updateFilter(key, value) {
            appState.filters[key] = value;
            filterCandidates();
        }
        
        function updateVisualizations(candidates) {
            const counts = (arr, key) => arr.reduce((acc, c) => {
                const k = key(c);
                if (k) acc[k] = (acc[k] || 0) + 1;
                return acc;
            }, {});

            const regionCounts = counts(candidates, c => REVERSE_REGIONES_MAP[c.r] || c.r);
            const partidoCounts = counts(candidates, c => c.p);
            const pactoCounts = counts(candidates, c => c.pc);
            
            updateMap(regionCounts);
            updateCharts(partidoCounts, regionCounts, pactoCounts);
            updateTopLists(partidoCounts, regionCounts, pactoCounts);
        }

        function updateMap(regionCounts) {
            const regionElements = document.querySelectorAll('.map-region');
            regionElements.forEach(regionEl => {
                const regionName = regionEl.getAttribute('data-region');
                const countEl = regionEl.querySelector('.region-count');
                const boxEl = regionEl.querySelector('.region-box');
                const count = regionCounts[regionName] || 0;
                
                countEl.textContent = count;
                boxEl.style.backgroundColor = getRegionColor(count);
                
                regionEl.onclick = () => showRegionDetails(regionName);
            });
        }
        
        function getRegionColor(count) {
            if (count > 120) return '#0D47A1';
            if (count > 90) return '#1976D2';
            if (count > 60) return '#42A5F5';
            if (count > 30) return '#90CAF9';
            if (count > 0) return '#E3F2FD';
            return '#f0f0f0';
        }

        function showRegionDetails(regionName) {
            const allCandidates = [...DATABASE.senadores, ...DATABASE.diputados];
            const regionCandidates = allCandidates.filter(c => (REVERSE_REGIONES_MAP[c.r] || c.r) === regionName);

            const senadoresCount = regionCandidates.filter(c => c.tipo === 'senador').length;
            const diputadosCount = regionCandidates.filter(c => c.tipo === 'diputado').length;
            const partidosCount = new Set(regionCandidates.map(c => c.p)).size;
            const pactosCount = new Set(regionCandidates.map(c => c.pc)).size;

            elements.regionDetails.innerHTML = `
                <h4>Estad√≠sticas de ${regionName}</h4>
                <div class="region-stats-grid">
                    <div class="region-stat">
                        <div class="region-stat-value">${regionCandidates.length}</div>
                        <div class="region-stat-label">Candidatos</div>
                    </div>
                    <div class="region-stat">
                        <div class="region-stat-value">${senadoresCount}</div>
                        <div class="region-stat-label">Senadores</div>
                    </div>
                    <div class="region-stat">
                        <div class="region-stat-value">${diputadosCount}</div>
                        <div class="region-stat-label">Diputados</div>
                    </div>
                    <div class="region-stat">
                        <div class="region-stat-value">${partidosCount}</div>
                        <div class="region-stat-label">Partidos</div>
                    </div>
                </div>
                <p style="margin-top: 15px;">Haz clic <a href="#" onclick="updateFilter('region', '${regionName}'); return false;">aqu√≠</a> para filtrar y ver los candidatos de esta regi√≥n.</p>
            `;
            
            document.querySelectorAll('.region-box').forEach(box => box.classList.remove('active'));
            const regionBox = document.querySelector(`.map-region[data-region="${regionName}"] .region-box`);
            if (regionBox) {
                regionBox.classList.add('active');
            }
        }

        function updateCharts(partidoCounts, regionCounts, pactoCounts) {
            const ctxPartidos = document.getElementById('chartPartidos').getContext('2d');
            const ctxRegiones = document.getElementById('chartRegiones').getContext('2d');
            const ctxPactos = document.getElementById('chartPactos').getContext('2d');
            const ctxTipoRegion = document.getElementById('chartTipoRegion').getContext('2d');
            
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { display: false },
                        ticks: {
                            color: '#666'
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            color: '#666',
                            autoSkip: true,
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            };

            const sortedPartidos = Object.entries(partidoCounts).sort(([, a], [, b]) => b - a).slice(0, 10);
            const partidosLabels = sortedPartidos.map(([p]) => p);
            const partidosData = sortedPartidos.map(([, c]) => c);
            if (charts.partidos) charts.partidos.destroy();
            charts.partidos = new Chart(ctxPartidos, {
                type: 'bar',
                data: {
                    labels: partidosLabels,
                    datasets: [{
                        label: 'Candidatos',
                        data: partidosData,
                        backgroundColor: '#0066CC',
                    }]
                },
                options: commonOptions
            });

            const sortedRegiones = Object.entries(regionCounts).sort(([, a], [, b]) => b - a);
            const regionesLabels = sortedRegiones.map(([r]) => r.split(' ')[0]);
            const regionesData = sortedRegiones.map(([, c]) => c);
            if (charts.regiones) charts.regiones.destroy();
            charts.regiones = new Chart(ctxRegiones, {
                type: 'bar',
                data: {
                    labels: regionesLabels,
                    datasets: [{
                        label: 'Candidatos',
                        data: regionesData,
                        backgroundColor: '#D52B1E',
                    }]
                },
                options: commonOptions
            });

            const sortedPactos = Object.entries(pactoCounts).sort(([, a], [, b]) => b - a);
            const pactosLabels = sortedPactos.map(([p]) => p);
            const pactosData = sortedPactos.map(([, c]) => c);
            
            const getRandomColor = () => '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            const pactoColors = pactosLabels.map(() => getRandomColor());

            if (charts.pactos) charts.pactos.destroy();
            charts.pactos = new Chart(ctxPactos, {
                type: 'doughnut',
                data: {
                    labels: pactosLabels,
                    datasets: [{
                        data: pactosData,
                        backgroundColor: pactoColors,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            const tipoRegionData = {};
            const allRegions = new Set([...Object.keys(regionCounts)]);
            allRegions.forEach(region => {
                const sen = DATABASE.senadores.filter(c => (REVERSE_REGIONES_MAP[c.r] || c.r) === region).length;
                const dip = DATABASE.diputados.filter(c => (REVERSE_REGIONES_MAP[c.r] || c.r) === region).length;
                tipoRegionData[region] = { sen, dip };
            });
            const tipoRegionLabels = Object.keys(tipoRegionData).map(r => r.split(' ')[0]);
            const senadoresByRegion = Object.values(tipoRegionData).map(d => d.sen);
            const diputadosByRegion = Object.values(tipoRegionData).map(d => d.dip);
            
            if (charts.tipoRegion) charts.tipoRegion.destroy();
            charts.tipoRegion = new Chart(ctxTipoRegion, {
                type: 'bar',
                data: {
                    labels: tipoRegionLabels,
                    datasets: [
                        {
                            label: 'Senadores',
                            data: senadoresByRegion,
                            backgroundColor: '#0066CC',
                        },
                        {
                            label: 'Diputados',
                            data: diputadosByRegion,
                            backgroundColor: '#D52B1E',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: { stacked: true }
                    }
                }
            });
        }
        
        function updateTopLists(partidoCounts, regionCounts, pactoCounts) {
            const renderList = (container, counts, total) => {
                const sorted = Object.entries(counts).sort(([, a], [, b]) => b - a).slice(0, 5);
                container.innerHTML = '';
                sorted.forEach(([key, value]) => {
                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                    const item = document.createElement('div');
                    item.className = 'detail-item';
                    item.innerHTML = `
                        <div class="detail-label">${key}</div>
                        <div class="detail-value">${value} (${percentage}%)</div>
                    `;
                    container.appendChild(item);
                });
            };

            const allCandidates = [...DATABASE.senadores, ...DATABASE.diputados];
            const totalCandidatos = allCandidates.length;

            renderList(elements.topPartidos, partidoCounts, totalCandidatos);
            renderList(elements.topRegiones, regionCounts, totalCandidatos);
            renderList(elements.topPactos, pactoCounts, totalCandidatos);
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>